{% extends "base.html" %}

{% block title %}Admin | Agentic CMS{% endblock %}

{% block content %}
<div class="container-fluid py-4 mt-5">
    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="card card-dark mb-3">
                <div class="card-body">
                    <h6 class="text-uppercase small fw-bold text-danger">System Status:</h6>
                    <div class="d-flex align-items-center mt-2">
                        <div class="status-indicator bg-success me-2 rounded-circle" style="width:10px; height:10px;"></div>
                        <span class="fw-bold small">LangChain Core: Online</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card card-dark mb-4">
                <div class="card-header border-0 pt-4">
                    <h4><i class="fas fa-magic text-gradient me-2"></i>Orchestrate Your Content</h4>
                    <p class="text-secondary small">
                        Say "It's a project about..." or "Update my about section..." or just describe a blog topic.
                    </p>
                </div>
                <div class="card-body">
                    <textarea class="form-control mb-3" id="agentPrompt" rows="3" placeholder="Ex: Add a new project called 'CryptoBot' that uses Python and Binance API..."></textarea>
                    <div class="text-end">
                        <button type="button" id="voice-btn" class="btn btn-dark border border-secondary" style="width: 50px; margin-right: 10px;" onclick="startDictation()" title="Use Voice">
                            <i class="fas fa-microphone text-white"></i>
                        </button>
                        <button class="btn btn-primary px-4" id="btnGenerate">
                            <i class="fas fa-bolt me-2"></i>Generate
                        </button>
                    </div>
                </div>
            </div>

            <div class="card card-dark">
                <div class="card-header border-0">
                    <h5 class="mb-0">Draft Preview <span class="badge ms-2" id="typeBadge"></span></h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="small fw-bold text-secondary">Title / Section</label>
                        <input type="text" class="form-control" id="draftTitle">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-secondary">Tags / Tech Stack</label>
                        <input type="text" class="form-control" id="draftTags">
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-secondary">Content</label>
                        <div id="draftContentPreview" class="p-3 border rounded" style="min-height: 200px; background: #000;">
                            <em class="text-muted">Agent output will appear here...</em>
                        </div>
                        <input type="hidden" id="draftContentHidden">
                        <input type="hidden" id="draftType">
                    </div>
                </div>
                <div class="card-footer border-0 text-end">
                    <button class="btn btn-primary" id="btnSave"><i class="fas fa-save me-2"></i>Publish</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4 m-2">
    <div class="col-md-12">
        <h4 class="fw-bold mb-3 text-secondary">Manage Database</h4>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card card-dark h-100">
            <div class="card-header border-0 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold"><i class="fas fa-pen-nib me-2 text-primary"></i>Blogs</h6>
                <span class="badge bg-secondary">{{ blogs|length }}</span>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush bg-transparent">
                    {% for blog in blogs %}
                    <li class="list-group-item bg-transparent border-secondary text-secondary d-flex justify-content-between align-items-center">
                        <div class="text-truncate me-2" style="max-width: 80%;">
                            <span class="text-white">{{ blog.title }}</span>
                            <br><small style="font-size: 0.8rem;">{{ blog.created_at }}</small>
                        </div>
                        <button onclick="deleteItem('blog', {{ blog.id }})" class="btn btn-sm btn-outline-danger border-0">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </li>
                    {% else %}
                    <li class="list-group-item bg-transparent text-muted text-center p-3">No blogs found.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card card-dark h-100">
            <div class="card-header border-0 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold"><i class="fas fa-laptop-code me-2 text-warning"></i>Projects</h6>
                <span class="badge bg-secondary">{{ projects|length }}</span>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush bg-transparent">
                    {% for project in projects %}
                    <li class="list-group-item bg-transparent border-secondary text-secondary d-flex justify-content-between align-items-center">
                        <div class="text-truncate me-2" style="max-width: 80%;">
                            <span class="text-white">{{ project.title }}</span>
                            <br><small style="font-size: 0.8rem;">{{ project.tech_stack }}</small>
                        </div>
                        <button onclick="deleteItem('project', {{ project.id }})" class="btn btn-sm btn-outline-danger border-0">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </li>
                    {% else %}
                    <li class="list-group-item bg-transparent text-muted text-center p-3">No projects found.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4 m-2">
    <div class="col-12">
        <div class="card card-dark">
            <div class="card-header border-0 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold"><i class="fas fa-inbox me-2 text-info"></i>Client Inbox</h5>
                <span class="badge bg-secondary">{{ messages|length }}</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 bg-transparent">
                        <thead class="text-secondary small text-uppercase">
                            <tr>
                                <th class="ps-4">Client</th>
                                <th>Message</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for msg in messages %}
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold text-white">{{ msg.name }}</div>
                                    <div class="small text-muted">{{ msg.email }}</div>
                                </td>
                                <td class="text-secondary">
                                    {{ msg.message }}
                                </td>
                                <td class="text-white small align-middle">
                                    {{ msg.created_at }}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center py-4 text-muted">No messages yet.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const btnGenerate = document.getElementById('btnGenerate');
    const btnSave = document.getElementById('btnSave');

    btnGenerate.addEventListener('click', async () => {
        const prompt = document.getElementById('agentPrompt').value;
        if(!prompt) return alert("Enter a prompt");

        btnGenerate.disabled = true;
        btnGenerate.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Thinking...';

        try {
            const res = await fetch('/api/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({prompt})
            });
            const data = await res.json();
            
            if(data.error) throw new Error(data.error);

            // Fill UI
            document.getElementById('draftTitle').value = data.title;
            document.getElementById('draftTags').value = data.tags;
            document.getElementById('draftContentHidden').value = data.content;
            document.getElementById('draftContentPreview').innerHTML = data.content;
            
            // Set Type
            document.getElementById('draftType').value = data.type;
            const badge = document.getElementById('typeBadge');
            badge.innerText = data.type.toUpperCase();
            
            // Color code the badge
            if(data.type === 'project') badge.className = 'badge bg-warning text-dark ms-2';
            else if(data.type === 'about') badge.className = 'badge bg-info text-dark ms-2';
            else badge.className = 'badge bg-primary ms-2';

        } catch (e) {
            alert(e.message);
        } finally {
            btnGenerate.disabled = false;
            btnGenerate.innerHTML = '<i class="fas fa-bolt me-2"></i> Generate';
        }
    });

    btnSave.addEventListener('click', async () => {
        const title = document.getElementById('draftTitle').value;
        const tags = document.getElementById('draftTags').value;
        const content = document.getElementById('draftContentHidden').value;
        const type = document.getElementById('draftType').value;

        const res = await fetch('/api/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title, tags, content, type})
        });
        
        const data = await res.json();
        if(data.status === 'success') {
            alert(data.type.toUpperCase() + ' Saved!');
            window.location.href = '/';
        } else {
            alert('Error: ' + data.error);
        }
    });

    function startDictation() {
        // Check for browser support (Chrome/Edge use webkit, others use standard)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (SpeechRecognition) {
            var recognition = new SpeechRecognition();

            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = "en-US";
            
            // Visual feedback
            var micBtn = document.getElementById('voice-btn');
            var originalIcon = '<i class="bi bi-mic"></i>'; // Or whatever icon class you use
            micBtn.innerHTML = "üî¥"; 

            recognition.start();

            recognition.onresult = function(e) {
                var transcript = e.results[0][0].transcript;
                
                // 2. FIX: Target the correct textarea ID ('agentPrompt')
                var promptBox = document.getElementById('agentPrompt');
                
                // Optional: Append to existing text instead of overwriting
                if (promptBox.value.length > 0) {
                    promptBox.value += " " + transcript;
                } else {
                    promptBox.value = transcript;
                }
                
                recognition.stop();
                micBtn.innerHTML = "üéôÔ∏è"; // Clear red dot
                // re-add icon if needed, or just leave blank if button has CSS icon
            };

            recognition.onerror = function(e) {
                console.error(e);
                micBtn.innerHTML = "üéôÔ∏è"; 
                alert("Voice Error: " + e.error);
                recognition.stop();
            };
            
            recognition.onend = function() {
                micBtn.innerHTML = "üéôÔ∏è"; // Reset button
            };

        } else {
            alert("Sorry, your browser does not support voice recognition. Try Google Chrome.");
        }
    }
    // DELETE FUNCTION
    async function deleteItem(type, id) {
        if(!confirm('Are you sure you want to delete this? This cannot be undone.')) return;

        try {
            const res = await fetch(`/api/delete/${type}/${id}`, {
                method: 'POST'
            });
            const data = await res.json();
            
            if(data.status === 'success') {
                // Refresh the page to show updated list
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        } catch(e) {
            console.error(e);
            alert('Failed to delete item.');
        }
    }
</script>
{% endblock %}